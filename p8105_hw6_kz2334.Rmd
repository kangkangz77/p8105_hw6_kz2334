---
title: "p8105_hw6_kz2334"
author: "Kangkang Zhang"
output: github_document
---

Load required packages.

```{r set up, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

library(tidyverse)
library(viridis)
library(purrr)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```


##Problem 1

Import the data. 
```{r 1.1 import, message = FALSE} 
homicide_data = read_csv("./data/homicide-data.csv")
```

Create a city_state variable, and a binary variable indicating whether the homicide is solved. 

```{r 1.2}
homicide_data = homicide_data %>% 
  mutate(city_state = str_c(city, ", ", state),
         status = ifelse(disposition %in% c("Closed without arrest", "Open/No arrest"), 0, 1))
```

Omit cities Dallas, TX; Phoenix, AZ; Kansas City, MO and Tulsa, AL. Modifiy victim_race to have categories white and non-white, with white as the reference category. Convert victim_age to numeric.

```{r 1.3, warning = FALSE}
homicide_md = homicide_data %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>% 
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white"),
         victim_race = as.factor(victim_race), 
         victim_race = relevel(victim_race, ref = "white"),
          victim_age = as.numeric(victim_age))
  
```

---

Run logistic regression for the city of Baltimore, MD. Find out the CI and estimate of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

```{r 1.4, message = FALSE}
balt_logistic = homicide_md %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

balt_logistic %>% 
  broom::tidy() %>%
  #extract OR and CIs for OR
  mutate(OR = exp(estimate),
    conf_low_or = exp(confint(balt_logistic, level = 0.95)[,1]),
    conf_high_or = exp(confint(balt_logistic, level = 0.95)[,2])) %>% 
  filter(term == "victim_racenon-white") %>% 
  select(OR, starts_with("conf")) %>% 
  knitr::kable(digit = 3)
```

We can see that adjusted OR for solving homicides comparing non-white victims to white victims in Baltimore is 0.441. 95% CI is (0.312, 0.620). The OR solving homicides for non-white victims is 0.441 times of that for white victims, which means non-white victims are less likely to be with solving homicides.

---

Run glm for each of the cities, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Create a dataframe with estimated ORs and CIs for each city.

```{r 1.5, message = FALSE, warning = FALSE}
homicide_md %>% 
  group_by(city_state) %>% 
  nest() %>%
  #run glm, extract estimates and CIs
  mutate(logistic = map(data, ~glm(status ~ victim_age + victim_sex + victim_race, 
                                   data = .x, family = binomial())),
         result = map(logistic, broom::tidy),
         conf = map(logistic, confint), 
         result_comb = map2(result, conf, cbind)) %>%
  select(city_state, result_comb) %>% 
  unnest() %>%
  filter(term == "victim_racenon-white") %>%
  janitor::clean_names() %>%
  #calculate OR and CIs
  mutate(OR = exp(estimate),
    conf_low_or = exp(x2_5_percent),
    conf_high_or = exp(x97_5_percent)) %>% 
  select(city_state, OR, starts_with("conf")) %>% 
  knitr::kable(digit = 3)
```

##Problem 2

Load and clean the data for regression analysis.

```{r 2.1, message = FALSE}
birth_data = read_csv("./data/birthweight.csv")

birth_data = birth_data %>%
  #convert categorical variables to factor
  mutate( babysex = as.factor(babysex),
          frace = as.factor(frace),
          malform = as.factor(malform),
          mrace = as.factor(mrace)
          )

#check NA values
birth_data %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  knitr::kable()

#check zero-equal values
birth_data %>% 
  summarise_all(funs(sum(. == 0))) %>% 
  knitr::kable()

```

Follow the dictionary of the dataset, I convert 4 variables to factor. Then I find out there is no  NA value in each variable. Then I check if there are zero values. I find that there is one missing value in family income and one missing value in motherâ€™s age at menarche. Luckily this is a small number.

